<!-- Treasury Tools Galaxy - Original 3D Sphere for WordPress.com -->
<!-- Attempting direct Three.js integration with better WordPress.com compatibility -->
<div id="treasury-galaxy-wp-3d" style="
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    border-radius: 16px;
    padding: 0;
    box-sizing: border-box;
    position: relative;
    min-height: 700px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    overflow: hidden;
">
    
    <!-- Loading State -->
    <div id="loading-state" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #ffffff; z-index: 50;">
        <h2 style="color: #f8f8f8; margin-bottom: 20px; font-size: clamp(1.8rem, 4vw, 2.5rem); font-weight: 700;">Treasury Tools Galaxy</h2>
        <p style="color: #ffffff; margin-bottom: 20px; font-size: clamp(1rem, 2.5vw, 1.2rem);">Loading 3D visualization...</p>
        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f8f8f8; border-top: 4px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
    </div>

    <!-- 3D Canvas -->
    <canvas id="galaxy-canvas-3d" style="width: 100%; height: 700px; display: none; touch-action: none;"></canvas>
    
    <!-- UI Overlays -->
    <div id="ui-overlay-3d" style="position: absolute; top: 20px; left: 20px; z-index: 100; background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 12px; color: #333333; display: none; font-family: inherit; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15); max-width: calc(100vw - 40px);">
        <div style="font-size: clamp(1.2rem, 3vw, 1.5rem); font-weight: 700; margin-bottom: 10px; background: linear-gradient(45deg, #3b82f6, #0ea5e9); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Treasury Galaxy</div>
        <div style="font-size: clamp(0.8rem, 2vw, 0.9rem); color: #333333; font-weight: 500;">
            üñ±Ô∏è <strong>Drag</strong> to rotate<br>
            üîç <strong>Scroll/Pinch</strong> to zoom<br>
            üëÜ <strong>Click</strong> tools for categories
        </div>
    </div>

    <!-- Controls -->
    <div id="controls-3d" style="position: absolute; bottom: 20px; left: 20px; z-index: 100; background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 12px; display: none; font-family: inherit; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);">
        <button onclick="resetView3D()" style="background: linear-gradient(45deg, #1e40af, #3b82f6); border: none; color: white; padding: 10px 15px; margin: 3px; border-radius: 6px; cursor: pointer; font-family: inherit; font-size: clamp(0.8rem, 2vw, 0.9rem);">üè† Reset</button>
        <button onclick="toggleAnimation3D()" style="background: linear-gradient(45deg, #1e40af, #3b82f6); border: none; color: white; padding: 10px 15px; margin: 3px; border-radius: 6px; cursor: pointer; font-family: inherit; font-size: clamp(0.8rem, 2vw, 0.9rem);">‚èØÔ∏è Auto-Spin</button>
    </div>

    <!-- Category Sidebar -->
    <div id="categories-sidebar-3d" style="position: absolute; top: 50%; right: 20px; transform: translateY(-50%); z-index: 100; background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 12px; display: none; font-family: inherit; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15); min-width: 250px; max-width: calc(100vw - 40px);">
        <h3 style="margin: 0 0 15px 0; color: #1e293b; font-size: clamp(1rem, 2.5vw, 1.2rem); font-weight: 600; text-align: center;">Treasury Categories</h3>
        
        <div class="category-card-3d" onclick="showCategory3D('TRMS')" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 15px; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.3s ease; touch-action: manipulation;">
            <div style="font-weight: 600; font-size: clamp(0.9rem, 2.2vw, 1rem); margin-bottom: 4px;">üè¢ TRMS</div>
            <div style="font-size: clamp(0.75rem, 1.8vw, 0.85rem); opacity: 0.9;">Treasury & Risk Management</div>
            <div style="font-size: clamp(0.7rem, 1.6vw, 0.8rem); opacity: 0.7; margin-top: 4px;">10 Enterprise Solutions</div>
        </div>
        
        <div class="category-card-3d" onclick="showCategory3D('CASH TOOLS')" style="background: linear-gradient(135deg, #0ea5e9, #0284c7); color: white; padding: 15px; border-radius: 8px; margin-bottom: 12px; cursor: pointer; transition: all 0.3s ease; touch-action: manipulation;">
            <div style="font-weight: 600; font-size: clamp(0.9rem, 2.2vw, 1rem); margin-bottom: 4px;">üí∞ CASH TOOLS</div>
            <div style="font-size: clamp(0.75rem, 1.8vw, 0.85rem); opacity: 0.9;">Cash Management & Forecasting</div>
            <div style="font-size: clamp(0.7rem, 1.6vw, 0.8rem); opacity: 0.7; margin-top: 4px;">10 Specialized Tools</div>
        </div>
        
        <div class="category-card-3d" onclick="showCategory3D('TMS-LITE')" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 15px; border-radius: 8px; margin-bottom: 0; cursor: pointer; transition: all 0.3s ease; touch-action: manipulation;">
            <div style="font-weight: 600; font-size: clamp(0.9rem, 2.2vw, 1rem); margin-bottom: 4px;">‚ö° TMS-LITE</div>
            <div style="font-size: clamp(0.75rem, 1.8vw, 0.85rem); opacity: 0.9;">Streamlined Platforms</div>
            <div style="font-size: clamp(0.7rem, 1.6vw, 0.8rem); opacity: 0.7; margin-top: 4px;">7 Mid-Market Solutions</div>
        </div>
    </div>

    <!-- Info Panel -->
    <div id="info-panel-3d" style="position: absolute; top: 20px; right: 20px; z-index: 100; background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 12px; max-width: 300px; color: #333333; opacity: 0; transition: opacity 0.3s; font-family: inherit; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);">
        <h3 id="tool-name-3d" style="color: #3b82f6; margin-bottom: 10px; font-weight: 600; font-size: clamp(1rem, 2.5vw, 1.2rem);">Select a Tool</h3>
        <p id="tool-desc-3d" style="color: #333333; line-height: 1.4; font-weight: 500; font-size: clamp(0.85rem, 2vw, 0.95rem);">Click on any treasury tool to explore categories</p>
    </div>

    <!-- Category Modal -->
    <div id="category-modal-3d" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 200; font-family: inherit;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 16px; padding: 0; max-width: min(800px, 95vw); width: 95%; max-height: 90vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
            <div id="modal-header-3d" style="background: linear-gradient(135deg, #3b82f6, #0ea5e9); color: white; padding: 25px; position: relative;">
                <h2 id="modal-title-3d" style="margin: 0 0 8px 0; font-size: clamp(1.3rem, 4vw, 1.8rem); font-weight: 700; padding-right: 50px;">Category Name</h2>
                <p id="modal-subtitle-3d" style="margin: 0; opacity: 0.9; font-size: clamp(0.9rem, 2.5vw, 1rem);">Treasury Management Solutions</p>
                <button onclick="closeModal3D()" style="position: absolute; top: 20px; right: 25px; background: rgba(255, 255, 255, 0.2); border: none; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; touch-action: manipulation;">‚úï</button>
            </div>
            <div style="padding: 25px; max-height: 60vh; overflow-y: auto; -webkit-overflow-scrolling: touch;">
                <div id="modal-content-3d"></div>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .category-card-3d:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }
        
        @media (max-width: 768px) {
            #categories-sidebar-3d {
                position: fixed;
                top: auto;
                bottom: 100px;
                right: 20px;
                left: 20px;
                transform: none;
                min-width: auto;
                max-width: none;
            }
            
            #info-panel-3d {
                display: none !important;
            }
        }
    </style>
</div>

<script>
// Treasury Tools Data with Spherical Coordinates
const treasuryTools3D = [
    // TRMS (10 tools) - Northern hemisphere
    { name: 'ATOM', category: 'TRMS', color: 0x3b82f6, desc: 'Advanced treasury and risk management platform with comprehensive derivatives and hedging capabilities', phi: 0.5, theta: 0 },
    { name: 'Coupa', category: 'TRMS', color: 0x3b82f6, desc: 'Business spend management platform with integrated treasury operations and procurement workflows', phi: 0.3, theta: 1 },
    { name: 'Datalog', category: 'TRMS', color: 0x3b82f6, desc: 'Comprehensive treasury management system with advanced analytics and multi-entity consolidation', phi: 0.7, theta: 2 },
    { name: 'GTreasury', category: 'TRMS', color: 0x3b82f6, desc: 'Cloud-based treasury and risk management solutions with strong accounting integration', phi: 0.4, theta: 3 },
    { name: 'Integrity', category: 'TRMS', color: 0x3b82f6, desc: 'Enterprise treasury platform with sophisticated risk management and compliance capabilities', phi: 0.6, theta: 4 },
    { name: 'IT2', category: 'TRMS', color: 0x3b82f6, desc: 'Integrated treasury technology platform with comprehensive cash and risk management features', phi: 0.2, theta: 5 },
    { name: 'Kyriba', category: 'TRMS', color: 0x3b82f6, desc: 'Leading cloud-based treasury and risk management platform with AI-powered analytics', phi: 0.8, theta: 0.5 },
    { name: 'Quantum', category: 'TRMS', color: 0x3b82f6, desc: 'Advanced treasury management system with real-time risk analytics and hedging optimization', phi: 0.35, theta: 1.5 },
    { name: 'Reval', category: 'TRMS', color: 0x3b82f6, desc: 'Comprehensive treasury and risk solutions with sophisticated derivatives management', phi: 0.65, theta: 2.5 },
    { name: 'WallStreet Suite', category: 'TRMS', color: 0x3b82f6, desc: 'Complete treasury and risk management platform with advanced analytics', phi: 0.45, theta: 3.5 },

    // CASH TOOLS (10 tools) - Equatorial region
    { name: 'Autocash.ai', category: 'CASH TOOLS', color: 0x0ea5e9, desc: 'AI-powered cash management platform with predictive analytics and automated forecasting', phi: 1.2, theta: 0.3 },
    { name: 'Balance', category: 'CASH TOOLS', color: 0x0ea5e9, desc: 'Real-time cash visibility platform with automated bank reconciliation', phi: 1.8, theta: 1.3 },
    { name: 'Nilus', category: 'CASH TOOLS', color: 0x0ea5e9, desc: 'Cash positioning and forecasting platform with advanced scenario planning', phi: 1.0, theta: 2.3 },
    { name: 'Obol', category: 'CASH TOOLS', color: 0x0ea5e9, desc: 'Digital treasury platform with real-time cash visibility and liquidity optimization', phi: 2.0, theta: 3.3 },
    { name: 'Panax', category: 'CASH TOOLS', color: 0x0ea5e9, desc: 'Working capital optimization platform with cash flow forecasting', phi: 1.4, theta: 4.3 },
    { name: 'Statement', category: 'CASH TOOLS', color: 0x0ea5e9, desc: 'Bank statement processing and cash reconciliation platform', phi: 1.6, theta: 5.3 },
    { name: 'Tesorio', category: 'CASH TOOLS', color: 0x0ea5e9, desc: 'Cash flow optimization platform with machine learning insights', phi: 1.1, theta: 0.8 },
    { name: 'Trovata', category: 'CASH TOOLS', color: 0x0ea5e9, desc: 'AI-powered cash visibility and management platform with real-time bank connectivity', phi: 1.9, theta: 1.8 },
    { name: 'Treasury Suite', category: 'CASH TOOLS', color: 0x0ea5e9, desc: 'Comprehensive cash management suite with forecasting and positioning', phi: 1.3, theta: 2.8 },
    { name: 'Vesto', category: 'CASH TOOLS', color: 0x0ea5e9, desc: 'Cash investment and liquidity management platform with yield optimization', phi: 1.7, theta: 3.8 },

    // TMS-LITE (7 tools) - Southern hemisphere
    { name: 'Bottomline', category: 'TMS-LITE', color: 0x10b981, desc: 'Payment automation and cash management platform with strong banking integration', phi: 2.3, theta: 0.7 },
    { name: 'City Financials', category: 'TMS-LITE', color: 0x10b981, desc: 'Streamlined treasury management system for mid-market companies', phi: 2.7, theta: 1.7 },
    { name: 'HighRadius', category: 'TMS-LITE', color: 0x10b981, desc: 'Autonomous finance platform with AI capabilities for treasury operations', phi: 2.5, theta: 2.7 },
    { name: 'Treasura', category: 'TMS-LITE', color: 0x10b981, desc: 'User-friendly treasury management system with essential features', phi: 2.9, theta: 3.7 },
    { name: 'Treasury Cube', category: 'TMS-LITE', color: 0x10b981, desc: 'Modular treasury platform with customizable features', phi: 2.4, theta: 4.7 },
    { name: 'Treasury Curve', category: 'TMS-LITE', color: 0x10b981, desc: 'Simplified treasury management solution with intuitive interface', phi: 2.6, theta: 5.7 },
    { name: 'Treasury4', category: 'TMS-LITE', color: 0x10b981, desc: 'Next-generation treasury platform with modern UI and cloud-native architecture', phi: 2.8, theta: 1.2 }
];

const categoryData3D = {
    'TRMS': {
        title: 'Treasury & Risk Management Systems',
        subtitle: 'Comprehensive Enterprise Solutions',
        description: 'Full-featured treasury management platforms designed for large enterprises with complex treasury operations, including sophisticated risk management, derivatives trading, and comprehensive reporting capabilities.',
        color: '#3b82f6'
    },
    'CASH TOOLS': {
        title: 'Cash Management Tools',
        subtitle: 'Specialized Cash Visibility & Forecasting',
        description: 'Focused solutions for cash visibility, forecasting, and liquidity management. These tools excel at providing real-time cash positions and predictive analytics without the complexity of full TMS platforms.',
        color: '#0ea5e9'
    },
    'TMS-LITE': {
        title: 'TMS-Lite Solutions',
        subtitle: 'Streamlined Treasury Platforms',
        description: 'Simplified treasury management systems that provide core treasury functionality without the complexity and cost of enterprise-grade platforms. Perfect for mid-market companies.',
        color: '#10b981'
    }
};

// 3D Scene variables
let scene3D, camera3D, renderer3D, toolsGroup3D;
let isAnimating3D = true;
let raycaster3D, mouse3D;
let isDragging3D = false;
let previousMousePosition3D = { x: 0, y: 0 };

// Try to load Three.js and initialize
function initGalaxy3D() {
    console.log('Attempting to initialize 3D Treasury Galaxy...');
    
    // Create a simple Three.js library inline to avoid CDN issues
    if (typeof THREE === 'undefined') {
        console.log('Loading Three.js...');
        loadThreeJS().then(() => {
            console.log('Three.js loaded, starting galaxy...');
            startGalaxy3D();
        }).catch((error) => {
            console.error('Failed to load Three.js:', error);
            showFallback3D();
        });
    } else {
        console.log('Three.js already available');
        startGalaxy3D();
    }
}

function loadThreeJS() {
    return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/three@0.128.0/build/three.min.js';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
}

function startGalaxy3D() {
    try {
        const container = document.getElementById('treasury-galaxy-wp-3d');
        const canvas = document.getElementById('galaxy-canvas-3d');
        
        if (!canvas || typeof THREE === 'undefined') {
            throw new Error('Canvas or THREE not available');
        }

        // Scene setup
        scene3D = new THREE.Scene();
        camera3D = new THREE.PerspectiveCamera(75, canvas.offsetWidth / canvas.offsetHeight, 0.1, 1000);
        camera3D.position.set(0, 0, 10);

        // Renderer setup
        renderer3D = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
        renderer3D.setSize(canvas.offsetWidth, canvas.offsetHeight);
        renderer3D.setClearColor(0x1e293b, 1);
        renderer3D.setPixelRatio(Math.min(window.devicePixelRatio, 2));

        // Create tools group
        toolsGroup3D = new THREE.Group();
        scene3D.add(toolsGroup3D);

        // Create wireframe sphere
        const sphereGeometry = new THREE.SphereGeometry(5, 32, 32);
        const sphereMaterial = new THREE.MeshBasicMaterial({
            color: 0xffffff,
            wireframe: true,
            transparent: true,
            opacity: 0.2
        });
        const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
        toolsGroup3D.add(sphere);

        // Create tool nodes
        createToolNodes3D();
        
        // Create star field
        createStarField3D();
        
        // Setup lighting
        setupLighting3D();
        
        // Setup interaction
        setupInteraction3D();

        // Show UI and start animation
        document.getElementById('loading-state').style.display = 'none';
        canvas.style.display = 'block';
        document.getElementById('ui-overlay-3d').style.display = 'block';
        document.getElementById('controls-3d').style.display = 'block';
        document.getElementById('categories-sidebar-3d').style.display = 'block';

        animate3D();
        console.log('3D Treasury Galaxy initialized successfully!');
        
    } catch (error) {
        console.error('Error initializing 3D galaxy:', error);
        showFallback3D();
    }
}

function createToolNodes3D() {
    const radius = 5.2;
    
    treasuryTools3D.forEach((tool, index) => {
        // Convert spherical coordinates to cartesian
        const x = radius * Math.cos(tool.phi) * Math.cos(tool.theta);
        const y = radius * Math.cos(tool.phi) * Math.sin(tool.theta);
        const z = radius * Math.sin(tool.phi);

        // Create tool sphere
        const toolGeometry = new THREE.SphereGeometry(0.15, 8, 8);
        const toolMaterial = new THREE.MeshPhongMaterial({
            color: tool.color,
            emissive: tool.color,
            emissiveIntensity: 0.3
        });
        
        const toolMesh = new THREE.Mesh(toolGeometry, toolMaterial);
        toolMesh.position.set(x, y, z);
        toolMesh.userData = tool;

        // Create text label
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.width = 256;
        canvas.height = 64;
        
        context.fillStyle = '#ffffff';
        context.strokeStyle = '#000000';
        context.lineWidth = 2;
        context.font = 'bold 18px Arial';
        context.textAlign = 'center';
        
        context.strokeText(tool.name, 128, 40);
        context.fillText(tool.name, 128, 40);

        const texture = new THREE.CanvasTexture(canvas);
        const textMaterial = new THREE.SpriteMaterial({ map: texture, transparent: true });
        const textSprite = new THREE.Sprite(textMaterial);
        textSprite.scale.set(2.5, 0.6, 1);
        textSprite.position.copy(toolMesh.position);
        textSprite.position.multiplyScalar(1.15);
        textSprite.userData = tool;

        toolsGroup3D.add(toolMesh);
        toolsGroup3D.add(textSprite);
    });
}

function createStarField3D() {
    const starGeometry = new THREE.BufferGeometry();
    const starCount = 500;
    const positions = new Float32Array(starCount * 3);

    for (let i = 0; i < starCount; i++) {
        positions[i * 3] = (Math.random() - 0.5) * 100;
        positions[i * 3 + 1] = (Math.random() - 0.5) * 100;
        positions[i * 3 + 2] = (Math.random() - 0.5) * 100;
    }

    starGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    
    const starMaterial = new THREE.PointsMaterial({ 
        color: 0xffffff, 
        size: 0.5,
        transparent: true,
        opacity: 0.8
    });
    const stars = new THREE.Points(starGeometry, starMaterial);
    scene3D.add(stars);
}

function setupLighting3D() {
    const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
    scene3D.add(ambientLight);

    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(1, 1, 1);
    scene3D.add(directionalLight);

    const pointLight = new THREE.PointLight(0x3b82f6, 0.5, 50);
    pointLight.position.set(15, 15, 15);
    scene3D.add(pointLight);
}

function setupInteraction3D() {
    raycaster3D = new THREE.Raycaster();
    mouse3D = new THREE.Vector2();
    
    const canvas = document.getElementById('galaxy-canvas-3d');
    
    // Mouse events
    canvas.addEventListener('mousedown', onMouseDown3D);
    canvas.addEventListener('mousemove', onMouseMove3D);
    canvas.addEventListener('mouseup', onMouseUp3D);
    canvas.addEventListener('click', onMouseClick3D);
    canvas.addEventListener('wheel', onMouseWheel3D, { passive: false });
    
    // Touch events
    canvas.addEventListener('touchstart', onTouchStart3D, { passive: false });
    canvas.addEventListener('touchmove', onTouchMove3D, { passive: false });
    canvas.addEventListener('touchend', onTouchEnd3D, { passive: false });
}

function onMouseDown3D(event) {
    isDragging3D = true;
    const rect = event.target.getBoundingClientRect();
    previousMousePosition3D = {
        x: event.clientX - rect.left,
        y: event.clientY - rect.top
    };
}

function onMouseMove3D(event) {
    if (!isDragging3D) return;
    
    const rect = event.target.getBoundingClientRect();
    const mousePos = {
        x: event.clientX - rect.left,
        y: event.clientY - rect.top
    };
    
    const deltaMove = {
        x: mousePos.x - previousMousePosition3D.x,
        y: mousePos.y - previousMousePosition3D.y
    };

    toolsGroup3D.rotation.y += deltaMove.x * 0.01;
    toolsGroup3D.rotation.x += deltaMove.y * 0.01;
    
    previousMousePosition3D = mousePos;
}

function onMouseUp3D() {
    isDragging3D = false;
}

function onMouseClick3D(event) {
    if (isDragging3D) return;
    
    const rect = event.target.getBoundingClientRect();
    mouse3D.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
    mouse3D.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

    raycaster3D.setFromCamera(mouse3D, camera3D);
    const intersects = raycaster3D.intersectObjects(toolsGroup3D.children);

    if (intersects.length > 0) {
        const tool = intersects[0].object.userData;
        if (tool && tool.name) {
            showCategory3D(tool.category);
        }
    }
}

function onMouseWheel3D(event) {
    event.preventDefault();
    const scaleFactor = event.deltaY > 0 ? 1.1 : 0.9;
    camera3D.position.multiplyScalar(scaleFactor);
    camera3D.position.clampLength(6, 25);
}

// Touch event handlers
let touchStart3D = null;
let isPinching3D = false;

function onTouchStart3D(event) {
    event.preventDefault();
    
    if (event.touches.length === 1) {
        isDragging3D = true;
        const rect = event.target.getBoundingClientRect();
        touchStart3D = {
            x: event.touches[0].clientX - rect.left,
            y: event.touches[0].clientY - rect.top
        };
    } else if (event.touches.length === 2) {
        isPinching3D = true;
        const touch1 = event.touches[0];
        const touch2 = event.touches[1];
        touchStart3D = {
            distance: Math.sqrt(
                Math.pow(touch2.clientX - touch1.clientX, 2) +
                Math.pow(touch2.clientY - touch1.clientY, 2)
            )
        };
    }
}

function onTouchMove3D(event) {
    event.preventDefault();
    
    if (event.touches.length === 1 && isDragging3D && touchStart3D) {
        const rect = event.target.getBoundingClientRect();
        const currentTouch = {
            x: event.touches[0].clientX - rect.left,
            y: event.touches[0].clientY - rect.top
        };
        
        const deltaMove = {
            x: currentTouch.x - touchStart3D.x,
            y: currentTouch.y - touchStart3D.y
        };

        toolsGroup3D.rotation.y += deltaMove.x * 0.015;
        toolsGroup3D.rotation.x += deltaMove.y * 0.015;
        
        touchStart3D = currentTouch;
    } else if (event.touches.length === 2 && isPinching3D) {
        const touch1 = event.touches[0];
        const touch2 = event.touches[1];
        const currentDistance = Math.sqrt(
            Math.pow(touch2.clientX - touch1.clientX, 2) +
            Math.pow(touch2.clientY - touch1.clientY, 2)
        );
        
        if (touchStart3D.distance) {
            const scaleFactor = touchStart3D.distance / currentDistance;
            camera3D.position.multiplyScalar(scaleFactor * 1.02);
            camera3D.position.clampLength(6, 25);
            touchStart3D.distance = currentDistance;
        }
    }
}

function onTouchEnd3D(event) {
    event.preventDefault();
    
    if (event.touches.length === 0) {
        isDragging3D = false;
        isPinching3D = false;
        touchStart3D = null;
    } else if (event.changedTouches.length === 1 && !isDragging3D) {
        // Handle tap for tool selection
        const touch = event.changedTouches[0];
        const rect = event.target.getBoundingClientRect();
        mouse3D.x = ((touch.clientX - rect.left) / rect.width) * 2 - 1;
        mouse3D.y = -((touch.clientY - rect.top) / rect.height) * 2 + 1;

        raycaster3D.setFromCamera(mouse3D, camera3D);
        const intersects = raycaster3D.intersectObjects(toolsGroup3D.children);

        if (intersects.length > 0) {
            const tool = intersects[0].object.userData;
            if (tool && tool.name) {
                showCategory3D(tool.category);
            }
        }
    }
}

function animate3D() {
    requestAnimationFrame(animate3D);
    
    if (isAnimating3D && !isDragging3D && !isPinching3D) {
        toolsGroup3D.rotation.y += 0.003;
    }
    
    if (renderer3D && scene3D && camera3D) {
        renderer3D.render(scene3D, camera3D);
    }
}

// Control functions
function resetView3D() {
    if (camera3D && toolsGroup3D) {
        camera3D.position.set(0, 0, 10);
        toolsGroup3D.rotation.set(0, 0, 0);
    }
}

function toggleAnimation3D() {
    isAnimating3D = !isAnimating3D;
}

// Category modal functions
function showCategory3D(categoryName) {
    const data = categoryData3D[categoryName];
    const categoryTools = treasuryTools3D.filter(tool => tool.category === categoryName);
    
    // Update modal
    document.getElementById('modal-title-3d').textContent = data.title;
    document.getElementById('modal-subtitle-3d').textContent = data.subtitle;
    document.getElementById('modal-header-3d').style.background = `linear-gradient(135deg, ${data.color}, ${adjustColor3D(data.color, -30)})`;
    
    // Build content
    let html = `<div style="margin-bottom: 20px; padding: 20px; background: #f1f5f9; border-radius: 8px; border-left: 4px solid ${data.color};">
        <p style="margin: 0; color: #475569; line-height: 1.6; font-size: clamp(0.9rem, 2vw, 1rem);">${data.description}</p>
    </div>`;
    
    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">';
    
    categoryTools.forEach(tool => {
        html += `<div style="background: #fff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; transition: all 0.3s ease; border-left: 4px solid ${data.color};">
            <h3 style="margin: 0 0 8px 0; color: #1e293b; font-size: clamp(1rem, 2.5vw, 1.2rem); font-weight: 600;">${tool.name}</h3>
            <p style="margin: 0; color: #64748b; line-height: 1.5; font-size: clamp(0.85rem, 2vw, 0.95rem);">${tool.desc}</p>
        </div>`;
    });
    
    html += '</div>';
    document.getElementById('modal-content-3d').innerHTML = html;
    document.getElementById('category-modal-3d').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeModal3D() {
    document.getElementById('category-modal-3d').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function adjustColor3D(hex, amount) {
    const num = parseInt(hex.replace('#', ''), 16);
    const r = Math.max(0, Math.min(255, (num >> 16) + amount));
    const g = Math.max(0, Math.min(255, (num >> 8 & 0x00FF) + amount));
    const b = Math.max(0, Math.min(255, (num & 0x0000FF) + amount));
    return `#${((r << 16) | (g << 8) | b).toString(16).padStart(6, '0')}`;
}

function showFallback3D() {
    console.log('Showing 3D fallback...');
    document.getElementById('loading-state').innerHTML = `
        <h2 style="color: #f8f8f8; margin-bottom: 20px; font-size: clamp(1.8rem, 4vw, 2.5rem); font-weight: 700;">Treasury Tools Catalog</h2>
        <p style="color: #ffffff; margin-bottom: 20px; font-size: clamp(1rem, 2.5vw, 1.2rem);">3D visualization unavailable. Complete product catalog:</p>
        <button onclick="initGalaxy3D()" style="background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin-bottom: 20px; font-size: clamp(0.9rem, 2vw, 1rem); font-weight: 600;">üîÑ Try 3D Again</button>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(min(280px, 100%), 1fr)); gap: 15px; max-width: 900px; padding: 0 20px;">
            <div style="background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 12px; border-left: 4px solid #3b82f6;">
                <h3 style="color: #3b82f6; margin-bottom: 12px; font-size: clamp(1.1rem, 2.5vw, 1.3rem); font-weight: 700;">üè¢ TRMS (10)</h3>
                <p style="color: #333333; font-size: clamp(0.85rem, 2vw, 0.95rem); line-height: 1.4; margin: 0;">ATOM, Coupa, Datalog, GTreasury, Integrity, IT2, Kyriba, Quantum, Reval, WallStreet Suite</p>
            </div>
            <div style="background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 12px; border-left: 4px solid #0ea5e9;">
                <h3 style="color: #0ea5e9; margin-bottom: 12px; font-size: clamp(1.1rem, 2.5vw, 1.3rem); font-weight: 700;">üí∞ CASH TOOLS (10)</h3>
                <p style="color: #333333; font-size: clamp(0.85rem, 2vw, 0.95rem); line-height: 1.4; margin: 0;">Autocash.ai, Balance, Nilus, Obol, Panax, Statement, Tesorio, Trovata, Treasury Suite, Vesto</p>
            </div>
            <div style="background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 12px; border-left: 4px solid #10b981;">
                <h3 style="color: #10b981; margin-bottom: 12px; font-size: clamp(1.1rem, 2.5vw, 1.3rem); font-weight: 700;">‚ö° TMS-LITE (7)</h3>
                <p style="color: #333333; font-size: clamp(0.85rem, 2vw, 0.95rem); line-height: 1.4; margin: 0;">Bottomline, City Financials, HighRadius, Treasura, Treasury Cube, Treasury Curve, Treasury4</p>
            </div>
        </div>
    `;
}

// Handle window resize
window.addEventListener('resize', () => {
    if (camera3D && renderer3D) {
        const canvas = document.getElementById('galaxy-canvas-3d');
        camera3D.aspect = canvas.offsetWidth / canvas.offsetHeight;
        camera3D.updateProjectionMatrix();
        renderer3D.setSize(canvas.offsetWidth, canvas.offsetHeight);
    }
});

// Keyboard events
document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape') {
        closeModal3D();
    }
});

// Modal click outside to close
document.getElementById('category-modal-3d').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) {
        closeModal3D();
    }
});

// Initialize on page load
setTimeout(initGalaxy3D, 500);

console.log('Treasury Galaxy 3D script loaded');
</script>